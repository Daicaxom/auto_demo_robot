name: Robot Framework Tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    container:
      image: python:3.10-slim
      options: >-
        --shm-size=4g

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Cache system dependencies
      uses: actions/cache@v3
      with:
        path: /var/cache/apt
        key: ${{ runner.os }}-apt-${{ hashFiles('**/robot.yml') }}
        restore-keys: |
          ${{ runner.os }}-apt-

    - name: Install system dependencies
      run: |
        apt-get update
        apt-get install -y wget apt-transport-https gnupg
        wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | gpg --dearmor -o /etc/apt/trusted.gpg.d/google-chrome.gpg
        echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list
        apt-get update
        apt-get install -y google-chrome-stable

    - name: Cache Python dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install robotframework==6.1.1 robotframework-seleniumlibrary==6.1.3 selenium==4.16.0 undetected-chromedriver==3.5.4

    - name: Cache test environment setup
      uses: actions/cache@v3
      with:
        path: Scripts
        key: ${{ runner.os }}-scripts-${{ hashFiles('**/robot.yml') }}
        restore-keys: |
          ${{ runner.os }}-scripts-

    - name: Create test environment setup
      run: |
        mkdir -p Scripts
        cat > Scripts/setup_test_env.py << 'EOF'
        import os
        import undetected_chromedriver.v2 as uc
        import uuid
        import shutil
        import tempfile

        def cleanup_chrome_dirs():
            temp_dir = tempfile.gettempdir()
            for item in os.listdir(temp_dir):
                if item.startswith('chrome_userdata_'):
                    try:
                        shutil.rmtree(os.path.join(temp_dir, item))
                    except:
                        pass

        def get_chrome_options(headless=True):
            cleanup_chrome_dirs()
            options = uc.ChromeOptions()
            if headless:
                options.add_argument('--headless=new')
            options.add_argument('--disable-gpu')
            options.add_argument('--disable-dev-shm-usage')
            options.add_argument('--no-first-run')
            options.add_argument('--no-service-autorun')
            options.add_argument('--no-default-browser-check')
            options.add_argument('--password-store=basic')
            # Generate a unique user data directory for each session
            unique_dir = os.path.join(tempfile.gettempdir(), f"chrome_userdata_{uuid.uuid4()}")
            options.add_argument(f'--user-data-dir={unique_dir}')
            return options

        def create_chromedriver(headless=True):
            options = get_chrome_options(headless)
            chrome = uc.Chrome(options=options)
            return chrome
        EOF

    - name: Run Robot Framework Tests
      env:
        BROWSER: chrome
        HEADLESS: "True"
        PYTHONUNBUFFERED: "1"
      run: |
        # Cleanup any existing Chrome processes
        pkill chrome || true
        pkill chromedriver || true
        
        # Remove existing Chrome user data directories
        rm -rf /tmp/chrome_userdata_* || true
        
        python -m robot \
          --outputdir reports \
          --variable BROWSER:${BROWSER} \
          --variable HEADLESS:${HEADLESS} \
          Calculator_v2/Tests/CalculatorTest.robot

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: robot-results
        path: reports/