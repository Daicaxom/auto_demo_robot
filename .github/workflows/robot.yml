name: Robot Framework Tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    container:
      image: python:3.10-slim
      options: >-
        --shm-size=4g

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Install system dependencies
      run: |
        apt-get update
        apt-get install -y wget apt-transport-https gnupg
        wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | gpg --dearmor -o /etc/apt/trusted.gpg.d/google-chrome.gpg
        echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list
        apt-get update
        apt-get install -y google-chrome-stable

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install robotframework==6.1.1 robotframework-seleniumlibrary==6.1.3 selenium==4.16.0 undetected-chromedriver==3.5.4

    - name: Create test environment setup
      run: |
        mkdir -p Scripts
        cat > Scripts/setup_test_env.py << 'EOF'
        import os
        import undetected_chromedriver.v2 as uc

        def get_chrome_options(headless=True):
            options = uc.ChromeOptions()
            if headless:
                options.add_argument('--headless=new')
            options.add_argument('--disable-gpu')
            options.add_argument('--disable-dev-shm-usage')
            options.add_argument('--no-first-run')
            options.add_argument('--no-service-autorun')
            options.add_argument('--no-default-browser-check')
            options.add_argument('--password-store=basic')
            return options

        def create_chromedriver(headless=True):
            options = get_chrome_options(headless)
            chrome = uc.Chrome(headless=headless, options=options)
            return chrome

        if __name__ == '__main__':
            driver = create_chromedriver(headless=True)
            try:
                driver.get("https://www.google.com")
                print("Google page loaded successfully in headless mode with undetected-chromedriver.")
            finally:
                driver.quit()
        EOF

    - name: Run Robot Framework Tests
      env:
        BROWSER: chrome
        HEADLESS: 'true'
      run: |
        python -m robot \
          --outputdir reports \
          --variable BROWSER:${BROWSER} \
          --variable HEADLESS:${HEADLESS} \
          Calculator_v2/Tests/CalculatorTest.robot

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: robot-results
        path: reports/