name: Robot Framework Tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    container:
      image: python:3.10-slim
      options: >-
        --shm-size=4g

    services:
      selenium:
        image: selenium/standalone-chrome:latest
        options: >-
          --shm-size=4g
        ports:
          - 4444:4444

    steps:
    - name: Checkout
      uses: actions/checkout@v3
      
    - name: Install system dependencies
      run: |
        apt-get update
        apt-get install -y wget unzip

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install robotframework==6.1.1 robotframework-seleniumlibrary==6.1.3 selenium==4.16.0

    - name: Create test environment setup
      run: |
        mkdir -p Scripts
        cat > Scripts/setup_test_env.py << 'EOF'
        from selenium import webdriver
        from selenium.webdriver.chrome.options import Options

        def get_chrome_options(headless=True):
            options = Options()
            if headless:
                options.add_argument('--headless=new')
            options.add_argument('--no-sandbox')
            options.add_argument('--disable-dev-shm-usage')
            options.add_argument('--disable-gpu')
            options.add_argument('--window-size=1920,1080')
            return options
        EOF

    - name: Run Robot Framework Tests
      env:
        SELENIUM_HUB_URL: http://selenium:4444/wd/hub
      run: |
        python -m robot \
          --outputdir reports \
          --variable BROWSER:chrome \
          --variable SELENIUM_HUB_URL:${SELENIUM_HUB_URL} \
          --variable HEADLESS:True \
          Calculator_v2/Tests/CalculatorTest.robot

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: robot-results
        path: reports/