name: Robot Framework Tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    container:
      image: python:3.10-slim
      options: >-
        --shm-size=4g

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Cache system dependencies
      uses: actions/cache@v4
      with:
        path: /var/cache/apt
        key: ${{ runner.os }}-apt-${{ hashFiles('**/robot.yml') }}
        restore-keys: |
          ${{ runner.os }}-apt-

    - name: Install system dependencies
      run: |
        apt-get update
        apt-get install -y wget apt-transport-https gnupg
        wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | gpg --dearmor -o /etc/apt/trusted.gpg.d/google-chrome.gpg
        echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list
        apt-get update
        apt-get install -y google-chrome-stable

    - name: Set up Python dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install Python packages
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Configure Chrome environment
      run: |
        mkdir -p Scripts
        python Scripts/setup_test_env.py

    - name: Execute Robot Framework Tests
      env:
        BROWSER: chrome
        HEADLESS: "True"
        PYTHONUNBUFFERED: "1"
        TEST_ENV: staging
      run: |
        # Kill existing Chrome processes and cleanup
        pkill -9 chrome || true
        pkill -9 chromedriver || true
        rm -rf /tmp/chrome_userdata_* || true

        # Run tests with custom Chrome driver
        python -m robot \
          --outputdir reports \
          --variablefile Scripts/setup_test_env.py \
          --variable BROWSER:${BROWSER} \
          --variable HEADLESS:${HEADLESS} \
          Calculator_v2/Tests/CalculatorTest.robot

    - name: Upload results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: robot-results
        path: reports/